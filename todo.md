# Rust Hex Editor - TODO List

## ✅ 実装済み

### 基本機能
- [x] gpuiライブラリの統合
- [x] 基本的なウィンドウ表示
- [x] 3カラムレイアウト（アドレス、Hex、ASCII）
- [x] 16進数表示とASCII表示
- [x] モノスペースフォントでの整列表示

### データモデル
- [x] バイト配列の管理 (`Vec<u8>`)
- [x] 16バイト/行のフォーマット
- [x] アドレス表示（8桁の16進数）
- [x] Hex値のフォーマット
- [x] ASCII文字の表示（制御文字は '.' で表示）
- [x] サンプルデータの生成

### ファイル操作
- [x] コマンドライン引数でファイルパスを受け取る
- [x] ファイルの読み込み (`load_file()`)
- [x] ファイル名のヘッダー表示
- [x] ファイルサイズの表示
- [x] エラーハンドリング（ファイル読み込み失敗時のフォールバック）

### UI/UX
- [x] ダークテーマ (#1e1e1e 背景)
- [x] スクロール可能なコンテンツ領域
- [x] インタラクティブなスクロールバー
  - [x] マウスホイール対応
  - [x] ドラッグ操作対応
  - [x] 常時表示モード
- [x] カラーコーディング
  - [x] アドレス: グレー (#808080)
  - [x] Hex値: グリーン (#00ff00)
  - [x] ASCII: ホワイト (#ffffff)

### カーソルとナビゲーション
- [x] カーソル位置の管理
  - [x] 現在のバイト位置を保持 (`cursor_position`)
  - [x] FocusHandleによるフォーカス管理
- [x] カーソルの視覚的表示
  - [x] 選択中のバイトをハイライト (青色 #4a9eff)
  - [x] HexペインとASCIIペインで同期表示
- [x] 基本的なキーボードナビゲーション
  - [x] 矢印キー（上下左右）でカーソル移動
  - [x] Focusableトレイト実装
  - [x] on_key_downイベント処理

### バイト編集機能
- [x] バイト編集モード
  - [x] Hexペインでの編集（0-9, A-F入力）
  - [x] ASCIIペインでの編集（印字可能文字）
  - [x] 入力値の検証
  - [x] Hexニブル管理（上位/下位ビット）
- [x] Hexペイン/ASCIIペインの切り替え（Tab）
- [x] 編集中の視覚的フィードバック
  - [x] 編集モード表示（ヘッダー）
  - [x] アクティブペインのハイライト（Hex: 青、ASCII: オレンジ）
  - [x] 非アクティブペインの暗い表示
- [x] 自動カーソル移動（入力後に次のバイトへ）

### ファイル保存機能
- [x] 変更追跡フラグ（has_unsaved_changes）
- [x] 上書き保存（Ctrl+S / Cmd+S）
- [x] 保存成功メッセージ表示
- [x] 未保存変更の視覚的表示
  - [x] タイトルに「*」表示
  - [x] バイト数に「(modified)」表示
- [x] 保存エラーハンドリング

---

## ❌ 未実装機能

### 🔴 高優先度（エディタとして必須）

#### 1. カーソルとナビゲーション（拡張）
- [x] カーソル位置の管理
  - [x] 現在のバイト位置を保持
  - [ ] Hexペイン/ASCIIペインの切り替え
- [x] カーソルの視覚的表示
  - [x] 選択中のバイトをハイライト
  - [x] カーソル位置のインジケーター
- [x] 基本的なキーボードナビゲーション
  - [x] 矢印キー（上下左右）
- [ ] 拡張キーボードナビゲーション
  - [ ] Page Up / Page Down
  - [ ] Home / End
  - [ ] Ctrl+Home / Ctrl+End（ファイルの先頭/末尾）
- [ ] マウス操作
  - [ ] クリックでバイト選択
  - [ ] ダブルクリックで単語選択
  - [ ] ドラッグで範囲選択

#### 2. 選択範囲
- [ ] 選択範囲の管理（開始位置、終了位置）
- [ ] 選択範囲のハイライト表示
  - [ ] Hexペインでの表示
  - [ ] ASCIIペインでの表示
  - [ ] 両ペインの同期
- [ ] Shift+矢印キーで範囲選択
- [ ] Ctrl+A で全選択

#### 3. 編集機能（拡張）
- [x] バイト編集モード
  - [x] Hexペインでの編集（0-9, A-F入力）
  - [x] ASCIIペインでの編集
  - [x] 入力値の検証
- [ ] 挿入/上書きモードの切り替え
- [x] 編集バッファの管理（Document構造体で実装済み）
  - [x] 変更箇所の追跡（Overlay HashMap）
  - [ ] 変更済みバイトの視覚的表示
- [x] Undo/Redo
  - [x] 編集履歴のスタック管理
  - [x] Ctrl+Z / Ctrl+Y
  - [x] 履歴の制限（メモリ管理、1000操作）

#### 4. ファイル保存（拡張）
- [x] 現在のファイルに上書き保存
- [ ] 別名で保存（新しいパスを指定）
  - [ ] ファイルダイアログの実装
- [ ] 保存確認ダイアログ
- [ ] 終了時の未保存変更警告
- [ ] 自動バックアップ（オプション）

#### 5. コピー&ペースト
- [ ] コピー機能（Ctrl+C）
  - [ ] 選択範囲のバイトをクリップボードにコピー
  - [ ] Hexフォーマット/バイナリフォーマットの選択
- [ ] ペースト機能（Ctrl+V）
  - [ ] クリップボードからバイトを貼り付け
  - [ ] フォーマットの自動検出
- [ ] カット機能（Ctrl+X）

#### 6. 仮想スクロール（パフォーマンス最適化）
**目的**: 大きなファイルでもスムーズに表示・操作できるようにする

**現状の問題**:
- 現在、最大1000行までレンダリングを制限
- 大きなファイル（例：187KB = 11,738行）では最初の1000行しか表示できない
- 全行をレンダリングしようとするとウィンドウが表示されない

##### Phase 1: スクロール位置の追跡 ✅ 完了
- [x] `scroll_offset: Pixels`フィールドを追加
- [x] 行の高さ定数を定義（`ROW_HEIGHT = 20.0px`、Phase 2で使用予定）
- [x] スクロールイベントのハンドリング（render()内で実装）
- [x] ScrollHandleからスクロール位置を取得（offset()メソッド使用）

##### Phase 2: 表示領域の計算
- [ ] ビューポートサイズの取得方法を調査
- [ ] 表示範囲計算メソッドの実装
  - [ ] first_visible_row の計算
  - [ ] visible_row_count の計算
  - [ ] バッファ行の追加（ちらつき防止）

##### Phase 3: レンダリングの最適化
- [ ] コンテンツ全体の高さを設定
- [ ] 表示領域内の行のみレンダリング
- [ ] 各行の位置を絶対座標で指定
- [ ] スクロール用のスペーサー要素を追加

##### Phase 4: スクロールイベントの処理
- [ ] スクロールイベントで`scroll_offset`を更新
- [ ] 再レンダリングのトリガー
- [ ] パフォーマンス測定（目標: 60fps）

##### Phase 5: カーソル追従機能
- [ ] カーソル移動時に表示範囲をチェック
- [ ] カーソルが画面外の場合、自動スクロール
- [ ] スムーズなスクロール体験の実装

---

### 🟡 中優先度（利便性向上）

#### 7. 検索機能
- [ ] 検索ダイアログ（Ctrl+F）
- [ ] バイナリ検索
  - [ ] Hex値での検索（例: "48 65 6C 6C 6F"）
  - [ ] ワイルドカード対応（"??" で任意のバイト）
- [ ] テキスト検索
  - [ ] ASCII文字列での検索
  - [ ] 大文字小文字の区別オプション
- [ ] 検索結果のナビゲーション
  - [ ] 次を検索（F3 / Ctrl+G）
  - [ ] 前を検索（Shift+F3）
  - [ ] すべての結果をハイライト
- [ ] 置換機能（Ctrl+H）

#### 8. ファイルダイアログ
- [ ] 「ファイルを開く」メニュー（Ctrl+O）
  - [ ] ネイティブファイルダイアログの表示
  - [ ] 最近使用したファイルのリスト
- [ ] 「名前を付けて保存」（Ctrl+Shift+S）
- [ ] ドラッグ&ドロップでファイルを開く

#### 9. 情報表示
- [ ] ステータスバー
  - [ ] 現在のバイト位置表示
  - [ ] 選択範囲のサイズ表示
  - [ ] ファイルサイズ表示
  - [ ] カーソル位置の値表示（Hex/Dec/Bin）
- [ ] データインスペクター
  - [ ] 選択バイトの解釈表示
  - [ ] Int8/16/32/64（符号あり/なし）
  - [ ] Float32/64
  - [ ] エンディアン切り替え（Little/Big）
- [ ] オフセット計算ツール
  - [ ] 基数変換（Hex ⇔ Dec ⇔ Bin）
  - [ ] オフセット演算

---

### 🟢 低優先度（追加機能）

#### 10. その他のパフォーマンス最適化
- [x] メモリマップドファイル（Document構造体で実装済み）
  - [x] ファイル全体をメモリに読み込まない
  - [x] オンデマンドでデータを読み込む（10MB以上）
- [ ] 差分レンダリング
  - [ ] 変更部分のみを再描画
  - [ ] スクロール時のパフォーマンス向上

#### 11. 高度な機能
- [ ] タブ機能
  - [ ] 複数ファイルの同時表示
  - [ ] タブの切り替え
  - [ ] タブのドラッグ&ドロップ
- [ ] 比較モード
  - [ ] 2つのファイルを並べて比較
  - [ ] 差分のハイライト
- [ ] ブックマーク
  - [ ] 重要な位置にブックマークを設定
  - [ ] ブックマーク間のジャンプ
- [ ] エクスポート
  - [ ] C配列形式でエクスポート
  - [ ] Base64エンコード
  - [ ] Hex dump形式

#### 12. カスタマイズ
- [ ] 設定画面
  - [ ] フォントサイズ変更
  - [ ] カラーテーマ変更
  - [ ] 1行あたりのバイト数変更（8/16/32）
- [ ] キーボードショートカットのカスタマイズ
- [ ] レイアウトの保存/復元

#### 13. その他
- [ ] コマンドパレット（Ctrl+Shift+P）
- [ ] ヘルプドキュメント
- [ ] チュートリアル
- [ ] 使用統計（オプション）

---

## 🔄 進行中: Document構造体リファクタリング

### 目的
データ管理とUI表示の責務を分離し、巨大ファイル対応とUndo/Redo機能の基盤を構築する。

### アーキテクチャ
- **DataBackend**: 小ファイル用のInMemory、大ファイル用のMemoryMapped
- **Overlay**: 編集バッファ（HashMap<offset, u8>）で変更箇所のみ保持
- **Edit History**: Undo/Redoスタック管理

### タスクリスト

#### Phase 1: Document基本実装 ✅ 完了
- [x] memmap2クレートをCargo.tomlに追加
- [x] src/document.rsファイルを作成
- [x] DataBackend enum実装（InMemory/MemoryMapped）
- [x] Edit構造体実装
- [x] Document構造体の基本定義
- [x] コンストラクタ実装（new, with_data, from_file）
- [x] ファイルI/O実装（load, save, save_as）
- [x] データアクセスメソッド実装（get_byte, get_slice, len）

#### Phase 2: 編集機能 ✅ 完了
- [x] Overlayベースのset_byte実装
- [x] 変更追跡機能（has_unsaved_changes, is_modified）
- [x] Undo/Redo実装（undo, redo, can_undo, can_redo）

#### Phase 3: HexEditorのリファクタリング ✅ 完了
- [x] HexEditor構造体をDocument使用に変更
- [x] データアクセスをdocument経由に移行
- [x] 編集操作をdocument.set_byte()に移行
- [x] ファイルI/Oをdocument経由に移行
- [x] 変更追跡ロジックをDocumentに委譲
- [x] Undo/Redoキーボードショートカット追加（Ctrl+Z / Ctrl+Y）

#### Phase 4: テストと検証（進行中）
- [x] 小ファイル（< 10MB）での動作確認
- [ ] 大ファイル（> 10MB）でのmmap動作確認
- [x] Undo/Redo機能実装完了
- [x] 保存機能動作確認
- [ ] パフォーマンス最適化（大量行のレンダリング問題）

---

## 📝 実装ノート

### 技術的な検討事項

1. **状態管理**
   - カーソル位置、選択範囲、編集バッファなどの状態をどう管理するか
   - gpuiの状態管理パターンに従う

2. **イベントハンドリング**
   - キーボード入力のハンドリング
   - マウスイベントのハンドリング
   - フォーカス管理

3. **描画最適化**
   - 大きなファイルでのパフォーマンス
   - スクロール時のちらつき防止

4. **ファイルI/O**
   - 非同期読み込み（UIブロックを防ぐ）
   - 部分的な読み込み（大容量ファイル対応）

### 次のステップ

推奨実装順序：
1. カーソル機能（位置管理 + 表示）
2. キーボードナビゲーション
3. バイト編集機能
4. 保存機能
5. 選択とコピー&ペースト
6. 検索機能

---

## 使い方（現在）

```bash
# サンプルデータを表示
cargo run

# ファイルを開く
cargo run -- <filepath>
cargo run -- Cargo.toml
```

## ビルドとテスト

```bash
# ビルド
cargo build
cargo build --release

# 実行
cargo run
cargo run -- path/to/file

# テスト
cargo test

# コード品質
cargo clippy
cargo fmt
```
